<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>èªæ†¶å¿ƒè²ï½œAIè§’è‰²ãƒ»èŠå¤©ãƒ»ç”Ÿå‘½åœ°åœ–</title>

  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css"/>
  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>

  <style>
  body{background:#eaeff4;font-family:"Inter","Microsoft JhengHei",system-ui;overflow:hidden}
  .screen{position:absolute;inset:0;display:flex;flex-direction:column}
    .hidden{display:none}
  /* å¼·åˆ¶æ‰‹æ©Ÿå°ºå¯¸ï¼ˆæ¡Œé¢ç‰ˆåªé¡¯ç¤ºæ‰‹æ©Ÿè¦–çª—ï¼‰ */
  .h-app{width:360px;height:640px;background:#fff;border-radius:1.5rem;overflow:hidden;box-shadow:0 25px 50px -12px rgba(0,0,0,.25);position:relative}
  /* å¯é¸çš„å¤–æ¡†æ¨£å¼ï¼Œè®“åœ¨æ¡Œé¢ä¸Šæ›´åƒæ‰‹æ©Ÿè£ç½® */
  .device-frame { padding: 18px; display:flex; align-items:center; justify-content:center; height:100vh; box-sizing:border-box }
  
  /* çœŸå¯¦æ‰‹æ©Ÿç’°å¢ƒä¸‹å¡«æ»¿æ•´å€‹è¢å¹• */
  @media (max-width: 480px) and (pointer: coarse) {
    .device-frame { 
      padding: 0; 
      margin: 0;
      height: 100vh;
      width: 100vw;
    }
    .h-app { 
      width: 100vw; 
      height: 100vh; 
      border-radius: 0; 
      box-shadow: none; 
      max-width: none;
      max-height: none;
    }
  }
    #map{width:100%;height:30vh;border-radius:0.5rem}
    .timeline{display:flex;align-items:center;justify-content:center;gap:48px;padding:12px 0;border-top:3px solid #a6622e;background:#fff}
    .timeline-dot{width:20px;height:20px;border-radius:50%;background:#a6622e}
    .card{background:#fff;border:1px solid #e5e7eb;border-radius:16px;box-shadow:0 2px 8px rgba(0,0,0,.06);padding:8px;cursor:pointer;transition:transform .12s ease, box-shadow .12s ease}
    .card:hover{transform:translateY(-2px);box-shadow:0 6px 14px rgba(0,0,0,.12)}
    .card img {
      width: 100%;
      height: auto;            /* ä¸å›ºå®šé«˜åº¦ï¼Œä¿æŒåŸæ¯”ä¾‹ */
      image-rendering: crisp-edges;  /* ğŸ§¡è®“åƒç´ éŠ³åˆ© */
      image-rendering: -webkit-optimize-contrast;
      border-radius: 12px;
    }
    /* ğŸ”§ ä¿®æ­£åœ°åœ–å±¤ç´šï¼Œç¢ºä¿å½ˆçª—æµ®åœ¨æœ€ä¸Šå±¤ */
    #map {
      z-index: 10 !important;
    }
    #map-view button {
      position: relative;
      z-index: 400; /* âœ… è®“æŒ‰éˆ•æµ®åœ¨åœ°åœ–ä¸Š */
      pointer-events: auto;
    }

    /* èŠå¤©è¦–åœ–å¸ƒå±€ä¿®æ­£ */
    #chat-view > div:first-child {
      display: flex !important;
      flex-direction: column !important;
      align-items: center !important;
      padding: 1rem !important;
      flex: 1 !important;
      overflow-y: auto !important;
      margin-top: 56px !important;
      max-height: calc(100vh - 200px) !important;
    }

    .character-container {
      width: 120px !important;
      height: 120px !important;
      min-width: 120px !important;
      min-height: 120px !important;
      flex-shrink: 0 !important;
      margin-bottom: 1rem !important;
      display: flex !important;
      align-items: center !important;
      justify-content: center !important;
    }

    .character-container img {
      width: 100% !important;
      height: 100% !important;
      object-fit: cover !important;
      border-radius: 50% !important;
    }

    #chat-box {
      flex: 1 !important;
      width: 100% !important;
      min-height: 100px !important;
      max-height: 200px !important;
      overflow-y: auto !important;
      text-align: center !important;
      padding: 0.5rem !important;
    }


    /* === åº•éƒ¨æ™‚é–“è»¸ === */
  .timeline-bottom {
      position: relative;
      bottom: 40px;
      left: 0;
      right: 0;
      display: flex;
      justify-content: center;
      align-items: center;
      gap: 40px;
  /* ä¿æŒåœ¨å°å¡ä¹‹ä¸Šä½†ä¸å‡Œé§•æ–¼ modal */
      z-index: 6000;
      align-items: flex-start; /* âœ… è®“åœ“é»é ä¸Šå°é½Šç·šæ¢ */
      pointer-events: auto;
      background: rgba(255, 255, 255, 0.0); /* âœ… å®Œå…¨é€æ˜ */
      height: auto;        /* âœ… å–æ¶ˆå›ºå®šé«˜åº¦ï¼Œé¿å…æ“ å£“ */
      padding: 6px 40px;
      overflow-x: auto;              /* âœ… å…è¨±æ©«å‘æ»¾å‹• */
      scroll-behavior: smooth;       /* âœ… å¹³æ»‘æ»¾å‹• */
      scrollbar-width: none;         /* âœ… éš±è—å·è»¸ï¼ˆFirefoxï¼‰ */
    }
    .timeline-bottom::-webkit-scrollbar {
      display: none; /* âœ… éš±è—å·è»¸ï¼ˆChromeï¼‰ */
    }


    /* === ç¯€é»æ¨£å¼ === */
  .timeline-dot {
      flex: none;           /* âœ… ä¸è¢« flex æ‹‰ä¼¸ */
      /* è®“ z-index ç”Ÿæ•ˆä¸¦å¯æµ®åœ¨æ©«ç·šä¸Šæ–¹ */
      position: relative;
      width: 40px;          /* âœ… å›ºå®šå¯¬åº¦ */
      height: 40px;         /* âœ… å›ºå®šé«˜åº¦ */
      border-radius: 50%;   /* âœ… è®Šåœ“å½¢ */
      background: radial-gradient(circle at 30% 30%, #d9b37c, #8b5e34);
      box-shadow: 0 2px 6px rgba(0, 0, 0, 0.25);
      cursor: pointer;
      transition: all 0.25s ease;
      display: inline-flex;       /* âœ… è®“æŒ‰éˆ•å…§éƒ¨ä¸è¢«æ’é–‹ */
      align-items: center;
      justify-content: center;
      padding: 0 0px 0 0px;
      margin: 0 10px 0 10px;
      line-height: 0;
      /* ç¢ºä¿åœ“é»åœ¨æ©«ç·šä¹‹ä¸Šï¼Œä½†ä½æ–¼ modal */
      z-index: 7000;
    }

    /* hover ç«‹é«”æµ®èµ·æ•ˆæœ */
    .timeline-dot:hover {
      transform: translateY(-3px) scale(1.1);
      background: radial-gradient(circle at 30% 30%, #e8c58f, #a56f3c);
      box-shadow: 0 6px 3px rgba(0, 0, 0, 0.35);
      border-radius: 20px;
    }

    /* active ç‹€æ…‹ */
    .timeline-dot.active {
      transform: scale(1.3);
      background: radial-gradient(circle at 30% 30%, #ffde9b, #b36b2c);
      box-shadow: 0 8px 16px rgba(0, 0, 0, 0.4);
      border-radius: 20px;
    }
    /* === å’–å•¡è‰²æ©«ç·š === */
    .timeline-bottom::before {
      content: "";
      position: absolute; /* âœ… å½å…ƒç´ å¿…é ˆçµ•å°å®šä½ */
      top: 50%;                      /* âœ… å°é½Šç¯€é»ä¸­é–“ */
            /* âœ… ç·šåœ¨åœ“é»ä¸‹æ–¹ */
      left: 0;
      right: 0;
      height: 5px;
      width: var(--line-width, 100%);       /* âœ… è·Ÿå…§å®¹ä¸€æ¨£é•· */
      background: #a6622e;     /* â˜• å’–å•¡è‰²ä¸»é¡Œ */
      border-radius: 20px;
      opacity: 0.7;
      /* æŠŠæ©«ç·šæ”¾åˆ°è¼ƒä½å±¤ï¼Œä¸¦ä¸æ””æˆªåœ“é»äº’å‹• */
      z-index: 0;
      pointer-events: none;
      margin: 0 5px 0 5px;
    }
      /* === Leaflet marker hover æ•ˆæœ === */
    .leaflet-marker-icon {
      border-radius: 12px; /* âœ… åœ“è§’ï¼ˆå¯ä¾åœ–å½¢æ¯”ä¾‹èª¿æ•´ï¼‰ */
      overflow: hidden;    /* âœ… é˜²æ­¢é™°å½±å¤–æº¢ */
      transition: transform 0.25s ease, filter 0.25s ease, box-shadow 0.25s ease;
      transform-origin: center bottom;
    }

    .leaflet-marker-icon:hover {
      transform: scale(1.2); /* æ”¾å¤§ä¸€é» */
      filter: brightness(1.15); /* æäº® */
      box-shadow: 0 0 12px rgba(255, 190, 120, 0.8); /* å…‰æšˆæ•ˆæœ */
      z-index: 100 !important; /* ç¢ºä¿æµ®åœ¨æœ€ä¸Šå±¤ */
    }
    #editModal {
      animation: fadeIn 0.3s ease;
      /* ç¢ºä¿ç·¨è¼¯ modal æ°¸é åœ¨æœ€ä¸Šå±¤ï¼ˆé«˜æ–¼æ™‚é–“è»¸èˆ‡ç¯€é»ï¼‰ */
      z-index: 200000 !important;
    }

    @keyframes fadeIn {
      from { opacity: 0; transform: scale(0.95); }
      to { opacity: 1; transform: scale(1); }
    }

    #editModal textarea {
      font-size: 15px;
      line-height: 1.5;
    }
    /* === ç”Ÿå‘½åœ°åœ–ä¸‹æ–¹çš„å°å¡å€å¡Š === */
    /* === å›ºå®šå°ºå¯¸ + éŸ¿æ‡‰å¼å®‰å…¨ç¯„åœçš„å°å¡ === */
    .photo-card {
      display: flex;
      flex-direction: row;       /* âœ… æ˜ç¢ºæŒ‡å®šæ©«å‘æ’åˆ— */
      align-items: center;
      justify-content: flex-start;
      background: #fff;
      border-radius: 12px;
      padding: 10px 12px;
      box-shadow: 0 3px 10px rgba(0, 0, 0, 0.1);
      gap: 12px;
      width: 90%;
      max-width: min(340px, 95vw);  /* âœ… æœ€å¤§ä¸è¶…éè¢å¹•å¯¬åº¦ */
      height: clamp(90px, 22vw, 100px);  /* âœ… æ ¹æ“šè¢å¹•è‡ªå‹•ç¸®æ”¾ */
      max-height: 100px;            /* âœ… æœ€å¤§é«˜åº¦é™åˆ¶ */
      margin: 0 auto;
      overflow: hidden;
      transition: transform 0.2s ease, box-shadow 0.2s ease;
    }
    .photo-card:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 16px rgba(0, 0, 0, 0.15);
    }

    /* å·¦å´åœ–ç‰‡ */
    .photo-card img {
      width: clamp(50px, 24vw, 60px);   /* âœ… åœ¨å°è¢å¹•ä¸‹è‡ªå‹•ç¸®å° */
      height: clamp(50px, 24vw, 60px);
      max-height: 60px;
      border-radius: 10px;
      object-fit: contain;          /* âœ… ç­‰æ¯”ä¾‹ç¸®å°é¡¯ç¤ºå®Œæ•´ */
      object-position: left;
      flex-shrink: 0;
      background: #ffff;
      border: 1px solid #d1d1d1;
    }

    /* å³å´æ–‡å­—å€å¡Š */
    .photo-card .info {
      display: flex;
      flex-direction: column;
      justify-content: center;   /* âœ… å‚ç›´ç½®ä¸­ */
      text-align: left;          /* âœ… æ–‡å­—é å·¦ */
      flex: 1;
      overflow: hidden;
    }

    .photo-card .info .title {
      font-weight: bold;
      color: #7a4a22;
      margin-bottom: 4px;
      white-space: nowrap;
      text-overflow: ellipsis;
      overflow: hidden;
      font-size: clamp(13px, 3.5vw, 15px); /* âœ… éŸ¿æ‡‰å¼å­—é«” */
    }

    .photo-card .info .date {
      font-size: 12px;
      color: #666;
      margin-bottom: 2px;
    }

    .photo-card .info div:last-child {
      font-size: 14px;
      color: #444;
      line-height: 1.4;
      max-height: 3.5em;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    /* === éŸ¿æ‡‰å¼ï¼ˆæ‰‹æ©Ÿè¢å¹• < 400pxï¼‰ === */
    @media (max-width: 400px) {
      .photo-card {
        height: 90px;
        max-width: 300px;
        gap: 8px;
        padding: 8px 10px;
      }
      .photo-card img {
        width: 70px;
        height: 70px;
      }
      .photo-card .info .title {
        font-size: 13px;
      }
      .photo-card .info div:last-child {
        font-size: 12px;
      }
    }
    #photo-card-container {
      position: relative;
      margin-top: -50px;   /* â¬†ï¸ è®“å°å¡å¾€ä¸Šé è¿‘åœ°åœ–ï¼Œä¾ä½ è¦çš„è·é›¢å¯èª¿æ•´ */
      z-index: 10;       /* âœ… æµ®åœ¨åœ°åœ–ä¸Šå±¤ */
      pointer-events: auto;
      transition: margin-top 0.3s ease;
    }

    /* å°å¡æœ¬é«”æ¨£å¼ */
    #photo-card-container .card {
      background: #fff;
      border: 1px solid #e5e7eb;
      border-radius: 16px;
      box-shadow: 0 2px 10px #ffde9b;
      padding: 10px;
      text-align: center;
      width: 90%;
      margin: 0 auto;
      position: relative;
      z-index: 5001;
      transition: transform 0.2s ease, box-shadow 0.2s ease;
    }

    /* hover æ•ˆæœï¼ˆå¾®æµ®èµ·ï¼‰ */
    #photo-card-container .card:hover {
      transform: translateY(-4px);
      box-shadow: 0 8px 18px #ffde9b;
    }


    /* å°å¡ä¸Šæµ®é¡¯ç¤º */
    .card-popup {
      animation: popup 0.4s ease forwards;
    }

    @keyframes popup {
      from { transform: translateY(30px); opacity: 0; }
      to { transform: translateY(0); opacity: 1; }
    }
    /* === ç¯€é»ç™¼å…‰å‹•ç•« === */
    .timeline-dot.active {
      transform: scale(1.3);
      background: radial-gradient(circle at 30% 30%, #ffde9b, #b36b2c);
      box-shadow: 
        0 0 3px rgba(255, 200, 100, 0.9);   /* ç™¼äº®æ ¸å¿ƒ */
      border-radius: 100%; /* âœ… ç¢ºä¿ä»æ˜¯åœ“å½¢ */
      transition: all 0.25s ease;
    }

    /* === åˆªé™¤æç¤ºå°è¦–çª— === */
    #deleteConfirm {
      position: fixed;
      inset: 0;
      background: rgba(0, 0, 0, 0.45);
      backdrop-filter: blur(4px);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 500;
    }
    #deleteConfirm .box {
      background: #fff;
      border-radius: 1rem;
      box-shadow: 0 4px 20px rgba(0, 0, 0, 0.25);
      width: 90%;                 /* âœ… æ”¹ç‚ºç™¾åˆ†æ¯”ï¼Œé©é…è¢å¹• */
      max-width: 320px;           /* âœ… æœ€å¤§å¯¬åº¦é™åˆ¶ï¼Œé¿å…å¤ªå¯¬ */
      padding: 16px;
      text-align: center;
      animation: fadeIn 0.3s ease;
      box-sizing: border-box;      /* âœ… ç¢ºä¿ padding ä¸é€ æˆè¶…å¯¬ */
      word-wrap: break-word;       /* âœ… é•·å­—ä¸æ’å‡ºè¢å¹• */
    }

    /* ğŸ”¹ åœ¨æ¥µå°è¢å¹•ï¼ˆä¾‹å¦‚ iPhone SEï¼‰è‡ªå‹•ç¸®å°å­—é«”èˆ‡é–“è· */
    @media (max-width: 400px) {
      #deleteConfirm .box {
        padding: 14px;
        max-width: 90%;
      }
      #deleteConfirm .box p {
        font-size: 14px;
      }
      #deleteConfirm button {
        font-size: 14px;
        padding: 6px 12px;
      }
    }

    #deleteConfirm button {
      margin: 8px;
      padding: 8px 16px;
      border-radius: 8px;
      font-weight: 600;
    }
    #deleteConfirm .confirm {
      background: #e57373;
      color: #fff;
    }
    #deleteConfirm .cancel {
      background: #ddd;
      color: #444;
    }

    .spinner{width:64px;height:64px;border-radius:50%;border:6px solid #e7e1db;border-top-color:#8b5e34;animation:spin 1s linear infinite}
    @keyframes spin{to{transform:rotate(360deg)}}
    .is-recording{animation:pulse 1s infinite;border:3px solid #ef4444}
    @keyframes pulse{0%,100%{box-shadow:0 0 0 0 rgba(239,68,68,.7)}70%{box-shadow:0 0 0 10px rgba(239,68,68,0)}}
    /* hero-textï¼šç½®ä¸­ä¸”é è¿‘ headerï¼Œä¸‹æ–¹ç•™ç™½èˆ‡å­—é«”å¾®èª¿ä»¥åŒ¹é… UI æˆªåœ– */
    #char-empty .hero-text {
      position: absolute;
      left: 1rem;
      right: 1rem;
      top: 30rem; /* å¯å†å¾®èª¿ï¼šæ•¸å­—è¶Šå°è¶Šé ä¸Š */
      text-align: center;
      margin: 0;
      color: #7a4a22;
      font-size: 1.15rem;
      line-height: 1.6;
      font-weight: 700;
      padding: 0.4rem 0;
      pointer-events: none; /* é¿å…è“‹åˆ°ä¸‹æ–¹æŒ‰éˆ•çš„é»æ“Š */
    }
    @media (max-width: 420px) {
      #char-empty .hero-text {
        top: 2.8rem;
        font-size: 1.05rem;
      }
    }
    /* è«è˜­è¿ªç¶ è‰²æ¼¸å±¤ï¼ˆä½é£½å’Œã€ç°åŒ–ã€æŸ”å’Œï¼‰ */
    .btn-map-gradient {
      /* Morandi-inspired muted greens */
      background:#4A7056;
      color: #fdfdfd; /* ç¨å¾®åæš–çš„æ·ºè‰²æ–‡å­—ï¼Œèˆ‡è«è˜­è¿ªè‰²ç³»å”èª¿ */
      padding: 0.5rem 0.75rem;
      border-radius: 0.75rem;
      transition: transform .12s ease, box-shadow .12s ease, filter .12s ease;
      /* æ›´æŸ”å’Œçš„é™°å½±ï¼Œå¸¶ä¸€é»ç°èª¿ */
      box-shadow: 0 2px 6px rgba(60, 72, 64, 0.08);
      border: 1px solid rgba(120,130,118,0.08);
    }
    .btn-map-gradient:hover {
      transform: translateY(-1px);
      /* hover è¼•å¾®åŠ æ·±é¡è‰²è€Œä¸æ˜¯è®Šäº®ï¼Œç¬¦åˆè«è˜­è¿ªæ²‰ç©©ç‰¹æ€§ */
      filter: brightness(0.96);
      box-shadow: 0 6px 10px rgba(60,72,64,0.10);
    }
  </style>
</head>

<body class="flex items-center justify-center h-screen">
  <div class="device-frame">
    <div class="h-app">
    <!-- Headerï¼šå…¨é å…±ç”¨ -->
    <header id="main-header" 
      class="flex items-center justify-between bg-[#4a6fa5] text-white py-3 px-3 
            absolute top-0 left-0 right-0 rounded-t-2xl shadow-md"
      style="z-index:8000 !important">
      <!-- è¿”å›æŒ‰éˆ• -->
      <button id="backBtn" onclick="handleBack()" class="text-sm opacity-90">â† è¿”å›</button>

      <!-- æ¨™é¡Œ -->
  <h1 id="pageTitle" class="text-lg font-semibold text-right px-12 flex-grow text-white select-none">AIè§’è‰²é¸æ“‡</h1>

      <!-- ä¸‰é»é¸å–® (åƒ…èŠå¤©ç•«é¢é¡¯ç¤º) -->
      <div id="chatMenu" class="relative">
        <button onclick="toggleDropdown('chat-dropdown')" 
          class="text-xl opacity-80 hover:bg-[#39587e] rounded-full px-2 mr-8 transition">â‹®</button>

        <!-- ä¸‹æ‹‰é¸å–® -->
        <div id="chat-dropdown" 
          class="absolute right-0 mt-3 w-28 bg-white rounded-lg shadow-xl py-1 z-20 hidden">
          <button onclick="showModal('åŠŸèƒ½æœªå¯¦ä½œï¼šèªè¨€')" 
            class="flex items-center px-4 py-2 text-sm text-gray-700 w-full text-left hover:bg-gray-100">ğŸŒ èªè¨€</button>
          <button onclick="openShareModal()" 
            class="flex items-center px-4 py-2 text-sm text-gray-700 w-full text-left hover:bg-gray-100">ğŸ”— åˆ†äº«</button>
          <button onclick="showModal('åŠŸèƒ½æœªå¯¦ä½œï¼šè¨­å®š')" 
            class="flex items-center px-4 py-2 text-sm text-gray-700 w-full text-left hover:bg-gray-100">âš™ï¸ è¨­å®š</button>
        </div>
      </div>

      <!-- é—œé–‰æŒ‰éˆ• -->
      <button class="text-lg opacity-80 ml-2" onclick="handleClose()">âœ–</button>
    </header>

  <!-- å…¨åŸŸ toastï¼ˆé¡¯ç¤ºåœ¨æ‰‹æ©Ÿæ¡†å…§ï¼‰ -->
  <div id="toast-container" class="fixed top-4 left-1/2 transform -translate-x-1/2 z-4000 hidden" style="width:88%"></div>

  <!-- ğŸŒŸ åˆ†äº«è¦–çª—ï¼ˆæ”¾åœ¨ body ä¸­ï¼Œç¢ºä¿èƒ½è¢«ä»»ä½•é é¢å‘¼å«ï¼‰ -->
  <div id="shareModal" 
    class="fixed inset-0 bg-black/40 flex items-center justify-center hidden transition" style="z-index:200100;">
    <div class="bg-white rounded-2xl w-11/12 max-w-sm p-6 shadow-2xl text-center relative mx-4">
      <h2 class="text-lg font-bold text-gray-800 mb-4">åˆ†äº«é€™å€‹é é¢</h2>
      
      <div class="flex flex-col gap-3">
        <button onclick="shareToFacebook()" 
          class="flex items-center justify-center gap-2 bg-[#1877F2] text-white font-semibold py-3 px-4 rounded-xl hover:bg-[#145BD1] transition">
          <img src="https://www.svgrepo.com/show/452196/facebook-1.svg" class="w-5 h-5" alt=""> Facebook
        </button>
        <button onclick="shareToLine()" 
          class="flex items-center justify-center gap-2 bg-[#06C755] text-white font-semibold py-3 px-4 rounded-xl hover:bg-[#05B04D] transition">
          <img src="https://www.line.me/static/img/icon-line_1.png" class="w-5 h-5" alt=""> LINE
        </button>
        <button onclick="copyLink()" 
          class="flex items-center justify-center gap-2 bg-gray-200 text-gray-800 font-semibold py-3 px-4 rounded-xl hover:bg-gray-300 transition">
          <svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 17l4 4 4-4m0-10l-4-4-4 4m4 14V3"/></svg>
          è¤‡è£½é€£çµ
        </button>
      </div>

      <!-- é—œé–‰æŒ‰éˆ• -->
      <button onclick="closeShareModal()" 
        class="absolute top-2 right-3 text-gray-500 hover:text-gray-800 text-lg font-bold">âœ•</button>
    </div>
  </div>



    <!-- A. åˆå§‹ç•«é¢ -->
    <section id="char-empty" class="screen">
      <div class="px-4 py-5 text-center flex-1 mt-[56px] relative"> <!-- é ç•™ header é«˜åº¦ -->

        <p class="text-2xl mt-[50px] font-bold text-[#7a4a22] leading-relaxed">
          ç›®å‰ç„¡è§’è‰²<br>å¯ä»¥åˆ©ç”¨æŒ‰éˆ•ç”Ÿæˆè§’è‰²ï¼
        </p>
        <div class="mt-8">
          <textarea id="charPrompt" rows="3"
            class="w-full rounded-2xl border border-gray-300 bg-gray-100 text-gray-600 text-center p-4"
            placeholder="éŒ„éŸ³æ–‡å­—é¡¯ç¤ºå€ï½œæ­¤å€æ–‡å­—å¯ç›´æ¥ä¿®æ”¹"></textarea>
        </div>
        <div class="mt-8 flex items-center justify-center gap-10">
          <button id="recordBtn" class="px-8 py-2 rounded-xl bg-[#c08955] text-white shadow">ğŸ¤  éŒ„éŸ³</button>
          <button id="charSend0" class="px-8 py-2 rounded-xl bg-[#c08955] text-white shadow">â–¶  é€å‡º</button>
        </div>
        <div class="mt-5">
          <button id="charAuto" class="w-full py-3 rounded-xl bg-[#e7c8a3] text-[#6d492b] font-bold shadow">
            âœ¨ è‡ª å‹• ç”Ÿ æˆ
          </button>
        </div>
      </div>
    </section>

    <!-- B. è¼‰å…¥ä¸­ -->
    <section id="char-loading" class="screen hidden">
      <div class="flex flex-col items-center justify-center flex-1 gap-4 mt-[56px]">
        <div class="spinner"></div>
        <div class="text-[#7a4a22] font-semibold text-lg">è¼‰å…¥ä¸­ï¼ŒAI æ­£åœ¨ç¹ªè£½è§’è‰²ä¸­...</div>
      </div>
    </section>

    <!-- C. ä¹å®®æ ¼ -->
    <section id="char-list" class="screen hidden">
      <div class="p-4 text-center flex-1 overflow-y-auto mt-[56px]">
        <p class="text-xl font-bold text-[#7a4a22] leading-relaxed mb-3">
          ğŸ‘‹ é¸æ“‡ä½ çš„AIå¤¥ä¼´è§’è‰²ï½
        </p>
        <div id="cardGrid" class="grid grid-cols-3 gap-3"></div>
      </div>
    </section>

    <!-- D. èŠå¤© -->


    <section id="chat-view" class="screen hidden relative">
      <div class="flex flex-col items-center gap-4 p-4 overflow-y-auto mt-[30px]">
        <div class="character-container">
          <img id="chat-avatar" src="https://placehold.co/144x144/f9d853/4a6fa5?text=AI" alt="AIé ­åƒ" />
        </div>
      </div>
      <!-- èŠå¤©å…§å®¹å€ - ç•™å‡ºåº•éƒ¨è¼¸å…¥å€ç©ºé–“ -->
      <div class="flex flex-col items-center gap-4 p-4 overflow-y-auto mt-[56px] mb-[180px]">
        <div id="chat-box" class="flex flex-col gap-3 text-center text-gray-800 text-lg font-semibold leading-relaxed p-4 w-full">
          <div class="text-gray-500 text-sm">ğŸ™ é»æ“Šä¸‹æ–¹éº¥å…‹é¢¨é–‹å§‹å°è©±</div>
        </div>
      </div>

      <!-- å›ºå®šåº•éƒ¨è¼¸å…¥å€ -->
      <div class="absolute bottom-0 left-0 right-0 border-t border-gray-200 bg-white py-3 flex flex-col items-center">
        <!-- è¼¸å…¥æ¬„ -->
        <textarea id="chatInput" rows="2"
          class="w-11/12 rounded-xl border border-gray-300 bg-gray-50 text-gray-700 p-3 text-sm mb-3"
          placeholder="éŒ„éŸ³æˆ–è¼¸å…¥æƒ³èªªçš„è©±..."></textarea>

        <!-- æŒ‰éˆ•å€åŸŸ -->
        <div class="flex flex-col items-center gap-3 w-full">
          <!-- éº¥å…‹é¢¨èˆ‡é€å‡ºæŒ‰éˆ• -->
          <div class="flex items-center gap-6 justify-center">
            <button id="recordBtnChat" class="px-4 py-2 flex items-center justify-center rounded-xl bg-[#d9b37c] text-white shadow text-sm">ğŸ¤éŒ„éŸ³</button>
            <button id="chatSend" class="px-4 py-2 rounded-xl bg-[#c08955] text-white shadow text-sm">â–¶ é€å‡º</button>
          </div>

          <!-- åˆ°ç”Ÿå‘½åœ°åœ–æŒ‰éˆ• -->
          <button id="toMapBtn" onclick="goToMap()" class="px-8 py-2 btn-map-gradient text-sm">åˆ°ç”Ÿå‘½åœ°åœ–</button>
        </div>
      </div>

    </section>

    <!-- E. åœ°åœ– -->
    <section id="map-view" class="screen hidden">
      <div class="p-2 mt-[56px]">
        <div id="map"></div>
        <div class="mt-2 flex gap-2 justify-center">
          <button class="flex-1 bg-green-200 py-2 rounded opacity-80 hover:opacity-100">â—€</button>
          <button class="flex-1 bg-green-200 py-2 rounded opacity-80 hover:opacity-100">â–¶</button>
        </div>
      </div>
      <div id="photo-card-container" class="px-3 flex-1 flex items-center justify-center text-gray-600 text-sm">
        é»æ“Šåœ°åœ–ä¸Šçš„ç”Ÿå‘½æ¨¹æ¨™è¨˜ï¼ŒæŸ¥çœ‹å›æ†¶ç…§ç‰‡ã€‚
      </div>
      <!-- ğŸŒŸ é ‚éƒ¨æ™‚é–“è»¸ -->
      <div id="timeline" class="timeline-bottom"></div>

    </section>
  <!-- ğŸŒŸ å°å¡ç·¨è¼¯ç•«é¢ -->
  <!-- æ”¹æˆ absoluteï¼Œè®“å®šä½èˆ‡å¯¬åº¦ç›¸å°æ–¼ .h-appï¼ˆå¯¬åº¦ 360px çš„æ‰‹æ©Ÿæ¡†ï¼‰ -->
  <div id="editModal" class="absolute inset-0 bg-black/50 backdrop-blur-sm flex items-center justify-center z-50 hidden">
  <div class="bg-white w-[78%] max-w-xs rounded-2xl shadow-2xl p-3 relative flex flex-col box-border">
        <h2 class="text-lg font-bold text-center text-[#7a4a22] mb-3">âœï¸ ç·¨è¼¯å›æ†¶å°å¡</h2>

        <textarea id="editTextArea" 
          class="w-full flex-1 border border-gray-300 rounded-xl p-3 text-gray-800 mb-3 resize-none"
          rows="8" placeholder="é€™è£¡é¡¯ç¤ºå®Œæ•´éŒ„éŸ³æ–‡å­—..."></textarea>

    <!-- ç…§ç‰‡é è¦½èˆ‡ä¸Šå‚³ -->
    <div class="flex flex-col items-center mb-3">
      <img id="editPreview" class="rounded-xl max-h-40 object-cover mb-2 hidden"/>
      <input type="file" id="editUpload" accept="image/*" class="text-sm"/>
      <div id="editUploadStatus" class="text-sm text-green-600 mt-2 hidden"></div>
    </div>

    <!-- æŒ‰éˆ•åˆ— -->
    <div class="flex justify-between mt-3">
      <button id="btnSaveEdit" class="bg-amber-400 text-[#5b3a17] px-4 py-2 rounded-lg font-bold">ğŸ’¾ å„²å­˜</button>
      <button id="btnCancelEdit" class="bg-red-300 text-white px-4 py-2 rounded-lg">å–æ¶ˆ</button>
    </div>
    </div>
  </div>
</div>
  <!-- ğŸŒŸ åˆªé™¤ç¢ºèªè¦–çª— -->
  <div id="deleteConfirm">
    <div class="box">
      <p class="text-lg font-bold text-[#7a4a22] mb-3">ğŸ—‘ ç¢ºå®šè¦åˆªé™¤æ­¤å›æ†¶å—ï¼Ÿ</p>
      <p class="text-sm text-gray-600 mb-4">åˆªé™¤å¾Œå°‡ç„¡æ³•å¾©åŸã€‚</p>
      <div>
        <button class="cancel" onclick="closeDeleteConfirm()">å–æ¶ˆ</button>
        <button class="confirm" onclick="confirmDelete()">åˆªé™¤</button>
      </div>
    </div>

      <!-- ğŸŒŸ ä»˜è²»ç¤ºæ„è¦–çª—ï¼ˆè²éŸ³ç”Ÿæˆåœ–ç‰‡éœ€ä»˜è²»ï¼‰ -->
      <div id="payModal" class="absolute inset-0 bg-black/40 backdrop-blur-sm flex items-center justify-center z-60 hidden">
        <div class="bg-white w-[86%] max-w-xs rounded-xl shadow-2xl p-4 relative flex flex-col box-border text-center">
          <h3 class="text-lg font-bold text-[#7a4a22] mb-2">ğŸ”’ éœ€è¦ä»˜è²»å•Ÿç”¨</h3>
          <p class="text-sm text-gray-600 mb-4">ä½¿ç”¨ã€Œè²éŸ³ç”¢ç”Ÿåœ–ç‰‡ã€åŠŸèƒ½éœ€ä»˜è²»è§£é–ã€‚ç¤ºæ„åƒ¹æ ¼ï¼šNT$30 / æ¬¡ã€‚</p>
          <div id="payPreview" class="text-sm text-gray-800 p-2 mb-4 bg-gray-50 rounded" style="min-height:48px;white-space:pre-wrap;text-align:left;"></div>
          <div class="flex gap-3 justify-center">
            <button id="btnConfirmPay" class="px-4 py-2 bg-[#e7c8a3] rounded-xl shadow">ä»˜è²»å•Ÿç”¨ (NT$30)</button>
            <button id="btnCancelPay" class="px-4 py-2 bg-gray-200 rounded-xl shadow">å–æ¶ˆ</button>
          </div>
        </div>
      </div>
  </div>

</div>
 

<script>    
// === Hugging Face èˆ‡æœ¬æ©Ÿ API è¨­å®š ===
const BACKEND_URL = "http://127.0.0.1:8010"; // ğŸš€ FastAPI åŸ·è¡Œä½å€ï¼ˆé–‹ç™¼ï¼šä½¿ç”¨ 8010ï¼Œé¿å… 8000 è¡çªï¼‰
const HF_IMAGE_URL = `${BACKEND_URL}/generate-gpt`;    // ğŸ¨ ç”Ÿåœ–ç«¯é»
const HF_PHOTO_URL = `${BACKEND_URL}/api/photo/upload`; // ğŸ–¼ ç…§ç‰‡ä¸Šå‚³
// ===== Hugging Face API è¨­å®š =====
const HF_ASR_URL = "https://api-inference.huggingface.co/models/openai/whisper-large-v3";
const HF_CHAT_URL =  `${BACKEND_URL}/api/chat`;

// === åœ°åœ– ===
// ä½¿ç”¨ä¿è­·å¼åˆå§‹åŒ–ï¼Œé¿å…åœ¨é–‹ç™¼æˆ–ç†±é‡è¼‰æœŸé–“é‡è¤‡å»ºç«‹ Leaflet åœ°åœ–
let map;
if (window.__lifeMap && window.__lifeMap instanceof L.Map) {
  console.log('é‡ç”¨å·²å­˜åœ¨çš„ Leaflet map instance');
  map = window.__lifeMap;
} else {
  map = L.map('map', { attributionControl: false }).setView([23.9739, 120.9820], 8);
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);
  // æš«å­˜æ–¼ window ä»¥ä¾¿æœªä¾†é‡ç”¨ï¼ˆä¾‹å¦‚ç†±é‡è¼‰æˆ–è…³æœ¬è¢«å¤šæ¬¡åŸ·è¡Œï¼‰
  window.__lifeMap = map;
}

// ğŸŒŸ è‡ªè¨‚ marker åœ–ç¤ºï¼ˆå¿…é ˆæ”¾åœ¨æœ€å‰é¢ï¼ï¼‰
const customIcon = L.icon({
  iconUrl: "assets/marker.png",
  iconSize: [30, 30],
  iconAnchor: [22, 44],
  popupAnchor: [0, -40]
});


// === é é¢åˆ‡æ› ===
const views = {
  empty: document.getElementById('char-empty'),
  loading: document.getElementById('char-loading'),
  list: document.getElementById('char-list'),
  chat: document.getElementById('chat-view'),
  map: document.getElementById('map-view')
};
const pageTitle = document.getElementById('pageTitle');
const chatMenu = document.getElementById('chatMenu');

let currentView = "empty";

// åˆ‡æ›ç•«é¢ä¸¦æ›´æ–°æ¨™é¡Œ + ä¸‰é»é¸å–®é¡¯ç¤ºç‹€æ…‹
function switchView(name) {
  currentView = name;
  for (const key in views) {
    views[key].classList.add("hidden");
  }
  views[name].classList.remove("hidden");

  // å‹•æ…‹æ›´æ–°æ¨™é¡Œï¼ˆä¿ç•™ chatMenu åœ¨æ‰€æœ‰é é¢å¯è¦‹ï¼‰
  switch (name) {
    case "empty":
    case "loading":
    case "list":
      pageTitle.textContent = "AIè§’è‰²é¸æ“‡";
      break;
    case "chat":
      pageTitle.textContent = "èŠå¤©å¹³å°";
      break;
    case "map":
      pageTitle.textContent = "ç”Ÿå‘½åœ°åœ–";
      break;
  }

  // åœ°åœ–é‡ç¹ª
  if (name === "map") {
    setTimeout(() => map.invalidateSize(), 200);
    loadMemories();      // âœ… æ¯æ¬¡åˆ‡æ›åœ°åœ–æ™‚è¼‰å…¥å›æ†¶
    renderTimeline();    // âœ… åŒæ­¥ç”Ÿæˆåº•éƒ¨ç¯€é»
  }

  // ç¢ºä¿ä¸‰é»é¸å–®ï¼ˆ#chatMenuï¼‰åœ¨æ‰€æœ‰é é¢éƒ½å¯è¦‹
  try { if (chatMenu) chatMenu.classList.remove('hidden'); } catch (e) {}
}

// è¿”å›é‚è¼¯
function handleBack() {
  if (currentView === "map") {
    switchView("chat");
  } else if (currentView === "chat") {
    // å›åˆ°è§’è‰²åˆ—è¡¨é ï¼ˆè€Œä¸æ˜¯ characterï¼‰
    switchView("list");
  } else if (currentView === "list" || currentView === "loading") {
    switchView("empty");
  } else {
    showToast('ç›®å‰å·²åœ¨æœ€å‰é ', { duration: 1800 });
  }
}

  // === ä¸‰é»é¸å–®é¡¯ç¤º / éš±è— ===
function toggleDropdown(id) {
  const dropdown = document.getElementById(id);
  // å…ˆé—œæ‰å…¶ä»– dropdownï¼ˆé¿å…é‡ç–Šï¼‰
  document.querySelectorAll('.dropdown, [id$="-dropdown"]').forEach(el => {
    if (el !== dropdown) el.classList.add('hidden');
  });
  // åˆ‡æ›ç•¶å‰ dropdown é¡¯ç¤º
  dropdown.classList.toggle('hidden');
}
// é–‹é—œåˆ†äº«è¦–çª— - å¼·ç¡¬åŒ–ç‰ˆæœ¬
function openShareModal() {
  try {
    console.log('openShareModal: attempting to show share modal');
    const el = document.getElementById("shareModal");
    if (!el) {
      console.error('openShareModal: shareModal element not found in DOM');
      return;
    }

    // å¼·åˆ¶ç§»å‹•åˆ° body æœ€å¾Œï¼ˆç¢ºä¿ä¸è¢«å…¶ä»–å®¹å™¨é™åˆ¶ï¼‰
    if (el.parentElement !== document.body) {
      document.body.appendChild(el);
      console.log('openShareModal: moved shareModal to document.body');
    }

    // å¼·ç¡¬è¨­å®šæ‰€æœ‰å¿…è¦å±¬æ€§
    el.classList.remove("hidden");
    el.style.display = 'flex';
    el.style.position = 'fixed';
    el.style.top = '0';
    el.style.left = '0';
    el.style.width = '100%';
    el.style.height = '100%';
    el.style.zIndex = '2147483647'; // æœ€é«˜ z-index
    el.style.pointerEvents = 'auto';
    el.style.opacity = '1';
    el.style.visibility = 'visible';
    el.style.background = 'rgba(0, 0, 0, 0.4)';
    el.style.alignItems = 'center';
    el.style.justifyContent = 'center';

    // ç¢ºä¿å…§éƒ¨ modal å…§å®¹åœ¨æ‰‹æ©Ÿä¸Šå¯è¦‹
    const modalContent = el.querySelector('div');
    if (modalContent) {
      modalContent.style.maxWidth = '90vw';
      modalContent.style.maxHeight = '90vh';
      modalContent.style.overflow = 'auto';
      modalContent.style.margin = '0 16px';
    }

    // æš«æ™‚ç¦ç”¨å…¶ä»–é«˜å±¤ç´šå…ƒç´ çš„äº’å‹•ï¼ˆé˜²æ­¢è¢«é®æ“‹ï¼‰
    const highZElements = document.querySelectorAll('[style*="z-index"]');
    highZElements.forEach(elem => {
      if (elem !== el && elem.style.zIndex && parseInt(elem.style.zIndex) > 10000) {
        elem.setAttribute('data-temp-pointer-events', elem.style.pointerEvents || 'auto');
        elem.style.pointerEvents = 'none';
      }
    });

    console.log('openShareModal: modal should now be visible with highest z-index and responsive design');
  } catch (e) { 
    console.error('openShareModal failed', e); 
  }
}

function closeShareModal() {
  try {
    const el = document.getElementById("shareModal");
    if (!el) return;
    
    el.classList.add("hidden");
    el.style.display = 'none';
    
    // æ¢å¾©å…¶ä»–å…ƒç´ çš„ pointer-events
    const tempElements = document.querySelectorAll('[data-temp-pointer-events]');
    tempElements.forEach(elem => {
      elem.style.pointerEvents = elem.getAttribute('data-temp-pointer-events');
      elem.removeAttribute('data-temp-pointer-events');
    });
    
    console.log('closeShareModal: modal hidden and restored other elements');
  } catch (e) { 
    console.error('closeShareModal failed', e); 
  }
}

// åˆ†äº«åŠŸèƒ½
function shareToFacebook() {
  const url = encodeURIComponent(window.location.href);
  const fbURL = `https://www.facebook.com/sharer/sharer.php?u=${url}`;
  window.open(fbURL, "_blank", "width=600,height=500");
}

function shareToLine() {
  const url = encodeURIComponent(window.location.href);
  const text = encodeURIComponent("å’Œæˆ‘ä¸€èµ·é«”é©—é€™å€‹ AI äº’å‹•å§ï¼");
  const lineURL = `https://social-plugins.line.me/lineit/share?url=${url}&text=${text}`;
  window.open(lineURL, "_blank", "width=600,height=500");
}

function copyLink() {
  const url = window.location.href;
  navigator.clipboard.writeText(url).then(() => {
    showToast('âœ”ï¸ å·²è¤‡è£½é€£çµåˆ°å‰ªè²¼ç°¿ï¼', { type: 'success' });
  }).catch(err => {
    showToast('âŒ è¤‡è£½å¤±æ•—ï¼Œè«‹æ‰‹å‹•è¤‡è£½ã€‚', { type: 'error' });
    console.error(err);
  });
}

// é€šç”¨çš„ç°¡å–®æç¤º modalï¼ˆå ä½ï¼‰
function showModal(message) {
  // è‹¥æœªå®šç¾©è©³ç´° modalï¼Œä½¿ç”¨ alert ä½œç‚ºå›é€€
  try {
    // è‹¥æœªä¾†è¦åšæ›´æ¼‚äº®çš„ modalï¼Œå¯åœ¨æ‰‹æ©Ÿæ¡†å…§é¡¯ç¤º toast
    showToast(message, { duration: 2500 });
  } catch (e) {
    console.log('showModal:', message);
  }
}


// è‹¥é»æ“Šå¤–éƒ¨å€åŸŸï¼Œå‰‡è‡ªå‹•é—œé–‰ä¸‹æ‹‰é¸å–®
window.addEventListener('click', function (e) {
  const menuBtn = e.target.closest('button[onclick^="toggleDropdown"]');
  const dropdown = e.target.closest('.dropdown, [id$="-dropdown"]');
  if (!menuBtn && !dropdown) {
    document.querySelectorAll('.dropdown, [id$="-dropdown"]').forEach(el => el.classList.add('hidden'));
  }
});

// ======= Toast (åœ¨æ‰‹æ©Ÿæ¡†å…§é¡¯ç¤ºéé˜»å¡æç¤º) =======
function showToast(message, opts = {}) {
  const container = document.getElementById('toast-container');
  if (!container) return;
  const id = `toast-${Date.now()}`;
  const type = opts.type || 'info';
  const duration = opts.duration || 3000;

  const el = document.createElement('div');
  el.id = id;
  el.className = 'px-4 py-2 rounded-lg text-sm shadow-md mb-2 text-white';
  el.style.transition = 'opacity 200ms ease, transform 200ms ease';
  el.style.opacity = '0';
  el.style.transform = 'translateY(-6px)';

  if (type === 'success') el.style.background = '#16a34a';
  else if (type === 'error') el.style.background = '#dc2626';
  else el.style.background = '#374151';

  el.innerText = message;
  container.appendChild(el);
  container.classList.remove('hidden');

  // animate in
  requestAnimationFrame(() => { el.style.opacity = '1'; el.style.transform = 'translateY(0)'; });

  setTimeout(() => {
    // animate out
    el.style.opacity = '0'; el.style.transform = 'translateY(-6px)';
    setTimeout(() => { try { container.removeChild(el); } catch (e) {} }, 250);
  }, duration);
}


  // é—œé–‰æŒ‰éˆ•
  function handleClose() {
    if (confirm("ç¢ºå®šè¦é—œé–‰å—ï¼Ÿ")) window.close();
  }

    // === æ¨¡æ“¬è§’è‰²ç”Ÿæˆ ===
    const charAuto=document.getElementById('charAuto');
    const cardGrid=document.getElementById('cardGrid');
    charAuto.onclick=()=>{switchView('loading');setTimeout(()=>{renderCharacterCards();switchView('list');},2000);};

    const demoCharacters=[
      {name:"é˜¿é’",img:"assets/char1.png"},
      {name:"é˜¿ç¦",img:"assets/char2.png"},
      {name:"å°å…‰",img:"assets/char3.png"},
      {name:"å°ç¶ ",img:"assets/char4.png"},
      {name:"å…ƒæ°£å›",img:"assets/char5.png"},
      {name:"æš–æš–",img:"assets/char6.png"},
      {name:"é˜¿å“²",img:"assets/char7.png"},
      {name:"å°å¤",img:"assets/char8.png"},
      {name:"é˜¿å‹‡",img:"assets/char9.png"}
    ];

    function renderCharacterCards(){
      cardGrid.innerHTML='';
      demoCharacters.forEach(c=>{
        const el=document.createElement('div');
        el.className='card';
        el.innerHTML=`<img src="${c.img}" alt="${c.name}">
                      <div class="pt-1 text-center font-bold text-sm">${c.name}</div>`;
        el.onclick=()=>selectCharacter(c);
        cardGrid.appendChild(el);
      });
    }
  function selectCharacter(c) {
    const chatAvatar = document.getElementById("chat-avatar");
    const chatBox = document.getElementById("chat-box");

    // æ›´æ–°é ­åƒèˆ‡å°è©±æ–‡å­—
    chatAvatar.src = c.img;
    chatBox.innerHTML = `
      <div class="text-gray-800 font-semibold text-lg">
        å—¨ï¼æˆ‘æ˜¯ ${c.name} ï½ ä¸€èµ·èŠèŠå§ï¼
      </div>
    `;

    // åˆ‡æ›åˆ°èŠå¤©é 
    switchView("chat");
  }



// === éŒ„éŸ³åŠŸèƒ½ï¼šçµæœå¡«å…¥è¼¸å…¥æ¡† ===

const recordBtn = document.getElementById("recordBtn");
const charPrompt = document.getElementById("charPrompt");

let mediaRecorder, audioChunks = [], isRecording = false;

recordBtn.onclick = async () => {
  if (!isRecording) {
    try {
      const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
      mediaRecorder = new MediaRecorder(stream);
      audioChunks = [];

      mediaRecorder.ondataavailable = e => audioChunks.push(e.data);
      mediaRecorder.onstop = async () => {
        const audioBlob = new Blob(audioChunks, { type: "audio/wav" });
        charPrompt.value = "ï¼ˆèªéŸ³è¾¨è­˜ä¸­...ï¼‰";

        const result = await transcribeAudio(audioBlob);

        // é¡¯ç¤ºè¾¨è­˜çµæœæ–¼è¼¸å…¥æ¡†
        charPrompt.value = result || "ï¼ˆèªéŸ³è¾¨è­˜å¤±æ•—ï¼‰";
      };

      mediaRecorder.start();
      recordBtn.classList.add("is-recording");
      recordBtn.textContent = "ğŸŸ¥ åœæ­¢";
      isRecording = true;
    } catch (err) {
  showToast('âŒ ç„¡æ³•å•Ÿç”¨éº¥å…‹é¢¨ï¼Œè«‹æª¢æŸ¥æ¬Šé™ã€‚', { type: 'error' });
      console.error(err);
    }
  } else {
    mediaRecorder.stop();
    recordBtn.classList.remove("is-recording");
    recordBtn.textContent = "ğŸ¤  éŒ„éŸ³";
    isRecording = false;
  }
};
// === å…±ç”¨éŒ„éŸ³åŠŸèƒ½ ===
function setupRecorder(buttonId, targetTextareaId) {
  const btn = document.getElementById(buttonId);
  const target = document.getElementById(targetTextareaId);
  let mediaRecorder, audioChunks = [], isRecording = false;

  btn.onclick = async () => {
    if (!isRecording) {
      try {
        const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
        mediaRecorder = new MediaRecorder(stream);
        audioChunks = [];

        mediaRecorder.ondataavailable = e => audioChunks.push(e.data);
        mediaRecorder.onstop = async () => {
          target.value = "ï¼ˆèªéŸ³è¾¨è­˜ä¸­...ï¼‰";
          const audioBlob = new Blob(audioChunks, { type: "audio/wav" });
          const text = await transcribeAudio(audioBlob);
          target.value = text || "ï¼ˆèªéŸ³è¾¨è­˜å¤±æ•—ï¼‰";
        };

        mediaRecorder.start();
        btn.classList.add("is-recording");
        btn.textContent = "ğŸŸ¥ åœæ­¢";
        isRecording = true;
      } catch (err) {
    showToast('âŒ ç„¡æ³•å•Ÿç”¨éº¥å…‹é¢¨æ¬Šé™', { type: 'error' });
        console.error(err);
      }
    } else {
      mediaRecorder.stop();
      btn.classList.remove("is-recording");
      btn.textContent = "ğŸ¤  éŒ„éŸ³";
      isRecording = false;
    }
  };
}


function appendMessage(sender, text) {
  const chatBox = document.getElementById("chat-box");
  const msg = document.createElement("div");
  msg.className = sender === "user" ? "text-right text-blue-700" : "text-left text-brown-700";
  msg.textContent = sender === "user" ? `ğŸ§‘â€ğŸ’¬ ${text}` : `ğŸ¤– å°å…‰ï¼š${text}`;
  chatBox.appendChild(msg);
  chatBox.scrollTop = chatBox.scrollHeight;
}

// ğŸ§ èªéŸ³ â†’ æ–‡å­—ï¼ˆå‘¼å« FastAPI çš„ /api/transcribeï¼‰
async function transcribeAudio(audioBlob) {
  try {
  const formData = new FormData();
  formData.append("file", audioBlob, "recording.webm");
  // è¦æ±‚å¾Œç«¯å›å‚³ç¹é«”ä¸­æ–‡ï¼ˆå¦‚æœå¾Œç«¯æœ‰ opencc å¯ç”¨ï¼‰
  formData.append("target_script", "tw");

    const response = await fetch(`${BACKEND_URL}/api/transcribe`, {
      method: "POST",
      body: formData,
    });

    if (!response.ok) {
      console.error("è½‰éŒ„å¤±æ•—", await response.text());
      return "ï¼ˆèªéŸ³è¾¨è­˜å¤±æ•—ï¼‰";
    }

    const result = await response.json();
    console.log("ASR å›å‚³çµæœï¼š", result);

    // æ”¯æ´ Hugging Face å›å‚³æ ¼å¼ï¼ˆæœ‰äº›æ¨¡å‹æ˜¯ listï¼Œæœ‰äº›æ˜¯ dictï¼‰
    if (Array.isArray(result)) {
      return result[0]?.text || result[0]?.generated_text || "ï¼ˆèªéŸ³è¾¨è­˜å¤±æ•—ï¼‰";
    }
    return result.text || result.generated_text || "ï¼ˆèªéŸ³è¾¨è­˜å¤±æ•—ï¼‰";

  } catch (e) {
    console.error("ASR Error:", e);
    // é¡¯ç¤ºåœ¨æ‰‹æ©Ÿæ¡†å…§ï¼Œä¸¦æç¤ºå•Ÿå‹•å¾Œç«¯
    showToast('âŒ èªéŸ³è½‰æ–‡å­—å¤±æ•—ï¼Œè«‹ç¢ºèªå¾Œç«¯æœå‹™å·²å•Ÿå‹•ï¼ˆ127.0.0.1:8010ï¼‰', { type: 'error', duration: 4000 });
    return "ï¼ˆèªéŸ³è¾¨è­˜å¤±æ•—ï¼‰";
  }
}
// === èŠå¤©é€å‡ºåŠŸèƒ½ ===
document.getElementById("chatSend").onclick = async () => {
  const inputBox = document.getElementById("chatInput");
  const text = inputBox.value.trim();
  if (!text) return showToast('è«‹å…ˆè¼¸å…¥æˆ–éŒ„éŸ³å…§å®¹ï¼', { type: 'error' });

  try {
    // âœ… å‘¼å«å¾Œç«¯ API å»ºç«‹æ–°å›æ†¶
    const res = await fetch(`${BACKEND_URL}/api/memories`, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ text })
    });

    if (!res.ok) {
      const msg = await res.text();
      throw new Error(msg);
    }

    const data = await res.json();
    console.log("è¨˜éŒ„å·²æ–°å¢ï¼š", data);

    // âœ… æ›´æ–°å°è©±æ¡†æç¤º
    appendMessage("user", text);
    appendMessage("ai", "âœ… å·²å°‡é€™æ®µæ–‡å­—å„²å­˜åˆ°ç”Ÿå‘½åœ°åœ–ï¼");
    inputBox.value = "";

      // ç«‹å³é‡æ–°è¼‰å…¥å›æ†¶ä¸¦æ›´æ–°æ™‚é–“è»¸ï¼Œç¢ºä¿æ–°ç¯€é»ç«‹å³é¡¯ç¤º
      try {
        await loadMemories();
        await renderTimeline();
      } catch (e) {
        console.warn('chatSend: failed to refresh timeline after creating memory', e);
      }

  } catch (err) {
    console.error("å„²å­˜å¤±æ•—ï¼š", err);
    showToast('âŒ ç„¡æ³•å„²å­˜ï¼Œè«‹ç¨å¾Œå†è©¦', { type: 'error' });
  }
};


// ğŸ’¬ å°å…‰å›è¦†ï¼ˆGemma æ¨¡å‹ï¼‰
async function getAIReply(text) {
  try {
    const response = await fetch(HF_CHAT_URL, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ text })
    });
    const data = await response.json();
    return data[0]?.generated_text || "æˆ‘è½ä¸å¤ªæ‡‚ï¼Œå†èªªä¸€æ¬¡å—ï¼Ÿ";
  } catch (err) {
    console.error("AI Error:", err);
    return "ï¼ˆå°å…‰æš«æ™‚æ²’å›æ‡‰ï¼‰";
  }
}


renderCharacterCards();
switchView('empty');

// === å¾å¾Œç«¯è¼‰å…¥æ‰€æœ‰å›æ†¶ ===
// === å¾å¾Œç«¯è¼‰å…¥æ‰€æœ‰å›æ†¶ï¼Œä¸¦åŒæ­¥ç•« marker + æŠ˜ç·š + æ™‚é–“è»¸ ===
async function loadMemories() {
  try {
    const res = await fetch(`${BACKEND_URL}/api/memories`);
    if (!res.ok) throw new Error("Failed to load memories");

  const memories = await res.json();
  // cache for global access (used by delegated handlers)
  try { window._memories = memories; } catch (e) { window._memories = memories; }
    console.log("ğŸ§­ å¾å¾Œç«¯å–å› memoriesï¼š", memories);

    const container = document.getElementById("photo-card-container");
    const timeline = document.getElementById("timeline");

    // ç„¡è³‡æ–™è™•ç†ï¼ˆåƒ…åœ¨å¾Œç«¯ç¢ºå¯¦å›ç©ºé™£åˆ—æ™‚æ¸…ç©ºæ™‚é–“è»¸ï¼‰
    if (!memories.length) {
      console.log('å¾Œç«¯å›å‚³ç©ºå›æ†¶é™£åˆ—ï¼Œæ¸…ç©ºæ™‚é–“è»¸');
      container.innerHTML = `<div class="text-gray-500 text-center mt-4">
        ç›®å‰é‚„æ²’æœ‰ä»»ä½•å›æ†¶è¨˜éŒ„ ğŸŒ±
      </div>`;
      timeline.innerHTML = "";
      if (window.memoryMarkers) window.memoryMarkers.forEach(m => map.removeLayer(m));
      if (window.memoryPolyline) map.removeLayer(window.memoryPolyline);
      return;
    }

    // ğŸ”¹ æ¸…é™¤èˆŠåœ–å±¤
    if (window.memoryMarkers) window.memoryMarkers.forEach(m => map.removeLayer(m));
    if (window.memoryPolyline) map.removeLayer(window.memoryPolyline);
    window.memoryMarkers = [];

    const validPoints = [];

    // === 1ï¸âƒ£ åœ¨åœ°åœ–ä¸Šç•« Marker ===
    memories.forEach(m => {
      if (m.lat !== null && m.lng !== null) {
        const marker = L.marker([m.lat, m.lng], { icon: customIcon })
          .addTo(map)
          .bindPopup(`<b>${m.place || "æœªçŸ¥åœ°é»"}</b><br>${m.text}`);
        marker.on("click", () => openMemoryCard({ currentTarget: marker }, m));
        window.memoryMarkers.push(marker);
        validPoints.push([m.lat, m.lng]);
      }
    });

    // === 2ï¸âƒ£ ä¸åœ¨åœ°åœ–ä¸Šç•«æŠ˜ç·šï¼ˆåƒ…åœ¨åº•éƒ¨æ™‚é–“è»¸é¡¯ç¤ºï¼‰ ===
    // åªä½¿ç”¨ markers çš„ç¯„åœä¾†èšç„¦åœ°åœ–ï¼Œä¸åœ¨åœ°åœ–ä¸Šç¹ªè£½æŠ˜ç·š
    if (validPoints.length > 1) {
      try {
        const bounds = L.latLngBounds(validPoints);
        map.fitBounds(bounds);
      } catch (e) {
        console.warn('fitBounds å¤±æ•—ï¼š', e);
      }
      // ä¸åœ¨åœ°åœ–å»ºç«‹ polylineï¼Œä¿ç•™ window.memoryPolyline ç‚º null
      window.memoryPolyline = null;
    } else if (validPoints.length === 1) {
      map.setView(validPoints[0], 10);
    }

    // === 3ï¸âƒ£ ç”Ÿæˆæ™‚é–“è»¸ç¯€é» ===
    timeline.innerHTML = "";
    timeline.style.display = "flex";
    // ä¾ created_at æ’åºï¼Œç¢ºä¿æ™‚é–“è»¸ç‚ºæ™‚é–“é †åºï¼ˆè‹¥æ²’æœ‰ created_at å‰‡ä¿ç•™åŸé †åºï¼‰
    try {
      memories.sort((a,b) => {
        if (!a.created_at || !b.created_at) return 0;
        return new Date(a.created_at) - new Date(b.created_at);
      });
    } catch (e) { /* non-fatal, keep original order */ }

    memories.forEach((m, idx) => {
      const dot = document.createElement("button");
      dot.className = "timeline-dot";
      dot.title = m.place || "æœªå‘½ååœ°é»";
      // å¦‚æœå¾Œç«¯æ²’æœ‰æä¾› idï¼Œä½¿ç”¨ fallback idï¼ˆä¸å¦å¤–è¼¸å‡º debugï¼‰
      dot.dataset.id = (m.id === undefined || m.id === null) ? `missing-${idx}` : m.id;
      dot.onclick = (e) => openMemoryCard(e, m);
      timeline.appendChild(dot);

      // ğŸ”¸ é•·æŒ‰åˆªé™¤åŠŸèƒ½ï¼ˆä½¿ç”¨å…±ç”¨ helperï¼Œæ”¯æ´ touch & mouse & å³éµï¼‰
      attachLongPress(dot, dot.dataset.id);
    });

    // è‹¥æœªç”¢ç”Ÿä»»ä½•ç¯€é»ï¼Œé¡¯ç¤ºç°¡çŸ­æç¤º
    if (timeline.children.length === 0) {
      timeline.innerHTML = `<div class="text-gray-500 text-sm">ï¼ˆå°šæœªæœ‰å¯é¡¯ç¤ºçš„æ™‚é–“è»¸ç¯€é»ï¼‰</div>`;
    }

    // ğŸ”¹ æ›´æ–°æ©«ç·šé•·åº¦
    requestAnimationFrame(() => {
      const dots = timeline.querySelectorAll(".timeline-dot");
      const gap = 80;
      const lineLength = (dots.length - 1) * gap + 200;
      timeline.style.setProperty("--line-width", `${lineLength}px`);
      // debug: log each dot's computed style
      dots.forEach((d, i) => {
        const cs = window.getComputedStyle(d);
        console.log(`timeline dot[${i}] id=${d.dataset.id} display=${cs.display} opacity=${cs.opacity} z-index=${cs.zIndex}`);
      });
    });

  } catch (err) {
    console.error("è¼‰å…¥å›æ†¶å¤±æ•—", err);
    const container = document.getElementById("photo-card-container");
    const timeline = document.getElementById("timeline");
    // é¡¯ç¤ºéŒ¯èª¤æç¤ºï¼Œä¸¦æ¸…ç©ºæ™‚é–“è»¸ï¼ˆé¿å…é¡¯ç¤ºå½é€ è³‡æ–™ï¼‰
    container.innerHTML = `<div class="text-red-600 text-center mt-4">ç„¡æ³•å¾å¾Œç«¯è¼‰å…¥å›æ†¶ï¼Œè«‹ç¢ºèªå¾Œç«¯æœå‹™å·²å•Ÿå‹•ï¼ˆ${BACKEND_URL}ï¼‰ã€‚</div>`;
    timeline.innerHTML = "";
    if (window.memoryMarkers) window.memoryMarkers.forEach(m => map.removeLayer(m));
    if (window.memoryPolyline) map.removeLayer(window.memoryPolyline);
    window.memoryMarkers = [];
    window.memoryPolyline = null;
    // ä¸å†ä½¿ç”¨ mock æ¸¬è©¦è³‡æ–™ï¼Œä»¥å…æ··æ·†çœŸå¯¦è³‡æ–™åº«çµæœ
  }
}

let deleteTargetId = null; // ğŸ”¸ æš«å­˜è¦åˆªé™¤çš„ memory id

// === é»æ“Šåœ°åœ–æ¨™è¨˜ï¼šå°æ‡‰ç¯€é»ç™¼å…‰ ===
function highlightTimelineDot(memoryId) {
  const dots = document.querySelectorAll(".timeline-dot");
  dots.forEach(d => {
    d.classList.remove("active");
    if (d.dataset.id == memoryId) d.classList.add("active");
  });
}
// å…±ç”¨ long-press èˆ‡å³éµåˆªé™¤ç¶å®šï¼Œæ”¯æ´ mouse èˆ‡ touch
function attachLongPress(el, memoryId, options = {}) {
  const holdDuration = options.holdDuration || 800;
  let holdTimer = null;

  const start = (e) => {
    // å¿½ç•¥å³éµçš„ mousedown
    if (e.type === 'mousedown' && e.button === 2) return;
    clear();
    holdTimer = setTimeout(() => {
      openDeleteConfirm(memoryId);
      holdTimer = null;
    }, holdDuration);
  };

  const clear = () => { if (holdTimer) { clearTimeout(holdTimer); holdTimer = null; } };

  el.addEventListener('mousedown', start);
  el.addEventListener('mouseup', clear);
  el.addEventListener('mouseleave', clear);

  el.addEventListener('touchstart', start, { passive: true });
  el.addEventListener('touchend', clear);
  el.addEventListener('touchcancel', clear);

  // å³éµä¹Ÿè§¸ç™¼åˆªé™¤ï¼ˆä¸¦é˜»æ­¢ç€è¦½å™¨é¸å–®ï¼‰
  el.addEventListener('contextmenu', (e) => {
    e.preventDefault();
    openDeleteConfirm(memoryId);
  });
}
// === ç•«å‡ºæ¨™è¨˜ä¸¦åŠ é»æ“Šäº‹ä»¶ ===
function renderMarkers(memories) {
  map.eachLayer(layer => {
    if (layer instanceof L.Marker) map.removeLayer(layer);
  });

  memories.forEach(m => {
    if (m.lat && m.lng) {
      const marker = L.marker([m.lat, m.lng], { icon: customIcon }).addTo(map);
      marker.on("click", () => highlightTimelineDot(m.id));
    }
  });
}

// === å·¦å³éµæ§åˆ¶æ™‚é–“è»¸ ===
// ä½¿ç”¨å®‰å…¨æ–¹å¼åœ¨ DOM å­˜åœ¨æ™‚åšæ»¾å‹•æ“ä½œï¼Œä¸¦å®‰å…¨ç¶å®šæŒ‰éˆ•äº‹ä»¶
function scrollTimelineLeft() {
  const tl = document.getElementById("timeline");
  if (tl) tl.scrollBy({ left: -150, behavior: "smooth" });
}

function scrollTimelineRight() {
  const tl = document.getElementById("timeline");
  if (tl) tl.scrollBy({ left: 150, behavior: "smooth" });
}

// å®‰å…¨ç¶å®šå·¦å³æŒ‰éˆ•ï¼ˆmap-view å…§çš„å…©å€‹ç¶ è‰²æŒ‰éˆ•ï¼‰
const _navBtns = document.querySelectorAll('.bg-green-200');
if (_navBtns && _navBtns.length >= 2) {
  _navBtns[0].onclick = scrollTimelineLeft;
  _navBtns[1].onclick = scrollTimelineRight;
}

// === é¡¯ç¤ºå°å¡ ===
function showMemoryCard(m) {
  const container = document.getElementById("photo-card-container");
  // æ”¹ç‚ºéœæ…‹é¡¯ç¤ºï¼ˆç·¨è¼¯å‹•ä½œæ”¹ç”±é›†ä¸­å¼çš„ #editModal è™•ç†ï¼Œç¶­æŒä¸€è‡´çš„è¦–çª—å¤§å°ï¼‰
  container.innerHTML = `
    <div class="bg-white rounded-xl shadow p-3 w-full text-center">
      <div class="font-bold text-[#7a4a22] mb-1">${m.place || "æœªå‘½ååœ°é»"}</div>
      <div class="text-sm text-gray-600 mb-2">${new Date(m.created_at).toLocaleString()}</div>

      <!-- æ–‡å­—é¡¯ç¤ºï¼ˆéå…§åµŒç·¨è¼¯ï¼‰ -->
      <div id="previewText-${m.id}" class="w-full p-2 mb-2 text-gray-800 text-left" style="white-space:pre-wrap;">${m.text}</div>

      <!-- ç…§ç‰‡é è¦½ï¼ˆè‹¥ç„¡å‰‡æç¤ºï¼‰ -->
      ${m.photo_url 
        ? `<img id="previewImg-${m.id}" src="${BACKEND_URL}${m.photo_url}" class="rounded-lg w-full mb-2">`
        : `<div id="previewImg-${m.id}" class="text-gray-400 mb-2">ï¼ˆå°šæœªä¸Šå‚³ç…§ç‰‡ï¼‰</div>`}

      <div class="flex gap-2 justify-center mt-2">
        <button id="openEditBtn-${m.id}" class="px-4 py-2 bg-[#e7c8a3] rounded shadow">âœï¸ ç·¨è¼¯</button>
      </div>
    </div>
  `;

  // ç¶å®šç·¨è¼¯æŒ‰éˆ•ï¼Œé–‹å•Ÿçµ±ä¸€çš„ç·¨è¼¯ modalï¼ˆ#editModalï¼‰ä»¥ç¶­æŒä¸€è‡´å¤§å°èˆ‡è¡Œç‚º
  const editBtn = document.getElementById(`openEditBtn-${m.id}`);
  if (editBtn) editBtn.onclick = () => openEditModal(m);
}


async function goToMap() {
  // âœ… åˆ‡æ›é é¢ä¸¦è¼‰å…¥æ‰€æœ‰å›æ†¶
  switchView("map");
  await loadMemories();
  await renderTimeline();

  // âœ… è‹¥ç›®å‰æ²’æœ‰ä»»ä½•å›æ†¶ï¼Œä»ç„¶é¡¯ç¤ºåœ°åœ–èƒŒæ™¯
  try {
    const res = await fetch(`${BACKEND_URL}/api/memories`);
    if (!res.ok) throw new Error('å¾Œç«¯å›å‚³éŒ¯èª¤');
    const memories = await res.json();
    if (!memories.length) {
      document.getElementById("photo-card-container").innerHTML =
        `<div class="text-gray-500 text-center mt-4">
           ç›®å‰é‚„æ²’æœ‰ä»»ä½•å›æ†¶è¨˜éŒ„ï¼Œå¿«ä¾†æ–°å¢ä¸€ç­†å§ ğŸŒ±
         </div>`;
    } else {
      map.setView([23.9739, 120.9820], 8); // èšç„¦å°ç£
    }
  } catch (err) {
    console.error('goToMap fetch memories éŒ¯èª¤ï¼š', err);
    document.getElementById("photo-card-container").innerHTML = `<div class="text-red-600 text-center mt-4">ç„¡æ³•é€£ç·šåˆ°å¾Œç«¯ï¼Œè«‹å•Ÿå‹•å¾Œç«¯æˆ–æª¢æŸ¥ç¶²è·¯ï¼ˆ${BACKEND_URL}ï¼‰ã€‚</div>`;
  }
  setTimeout(() => map.invalidateSize(), 200); // âœ… åªéœ€é€™è¡Œç¢ºä¿ Leaflet é‡ç¹ª
}
let currentOpenId = null; // âœ… ç”¨ä¾†è¨˜éŒ„ç›®å‰é–‹å•Ÿçš„å°å¡ ID

// === ç”Ÿæˆæ™‚é–“è»¸ç¯€é»ï¼ˆå®‰å…¨ wrapperï¼‰ ===
async function renderTimeline() {
  try {
    // ä½¿ç”¨ loadMemories ä½œç‚ºå–®ä¸€ä¾†æºï¼ˆloadMemories å«éŒ¯èª¤ fallback èˆ‡ mockï¼‰
    await loadMemories();
  } catch (err) {
    console.error('renderTimeline æ•ç²éŒ¯èª¤ï¼š', err);
    // loadMemories å·²è™•ç† mock fallbackï¼Œé€™è£¡ä¸å†æ¸…ç©º timeline
  }
}
// åˆæ¬¡å‘¼å«ï¼Œè®“é é¢å˜—è©¦è¼‰å…¥ï¼ˆè‹¥å¾Œç«¯å¤±æ•—ï¼Œæœƒä½¿ç”¨ mockï¼‰
renderTimeline();
// === é–‹å•Ÿåˆªé™¤ç¢ºèªè¦–çª— ===
function openDeleteConfirm(memoryId) {
  deleteTargetId = memoryId;
  document.getElementById("deleteConfirm").style.display = "flex";
}

// === é—œé–‰åˆªé™¤ç¢ºèªè¦–çª— ===
function closeDeleteConfirm() {
  deleteTargetId = null;
  document.getElementById("deleteConfirm").style.display = "none";
}

// === ç¢ºèªåˆªé™¤ ===
async function confirmDelete() {
  if (!deleteTargetId) return;

  try {
    const res = await fetch(`${BACKEND_URL}/api/memories/${deleteTargetId}`, { method: "DELETE" });
    if (res.ok) {
      showToast('ğŸ—‘ å·²åˆªé™¤å›æ†¶', { type: 'success' });
      await loadMemories();
      await renderTimeline();
    } else {
      showToast('âŒ åˆªé™¤å¤±æ•—', { type: 'error' });
    }
  } catch (err) {
    console.error(err);
    showToast('âš ï¸ ç™¼ç”ŸéŒ¯èª¤ï¼Œè«‹ç¨å¾Œå†è©¦', { type: 'error' });
  } finally {
    closeDeleteConfirm();
  }
}

// === é»æ“Šç¯€é»é–‹å°å¡ ===
function openMemoryCard(e, memory) {
  const container = document.getElementById("photo-card-container");

  // âœ… å¦‚æœå†æ¬¡é»åŒä¸€å€‹ç¯€é» â†’ é—œé–‰å°å¡
  if (currentOpenId === memory.id) {
    container.innerHTML = ""; // æ¸…ç©ºå°å¡
    currentOpenId = null;
    document.querySelectorAll(".timeline-dot").forEach(d => d.classList.remove("active"));
    return;
  }

  // âœ… æ›´æ–°ç›®å‰é–‹å•Ÿçš„ ID
  currentOpenId = memory.id;

  // === é¡¯ç¤ºå°å¡å…§å®¹ ===
  container.innerHTML = `
    <div class="photo-card card-popup">
      ${
        memory.photo_url
          ? `<img src="${BACKEND_URL}${memory.photo_url}" alt="ç…§ç‰‡" />`
          : `<div class="text-gray-400 italic flex items-center justify-center w-[90px] h-[90px] bg-gray-100 rounded-lg">
               (ç„¡ç…§ç‰‡)
             </div>`
      }
      <!-- å³å´æ–‡å­— -->
      <div class="info">
        <div class="title">${memory.place || "æœªå‘½ååœ°é»"}</div>
        <div class="date">${new Date(memory.created_at).toLocaleString()}</div>
        <div>${memory.text}</div>
        <div class="text-amber-600 text-xs mt-1">
          <button id="openEditBtn-card-${memory.id}" class="text-amber-600 text-xs">âœï¸ ç·¨è¼¯</button>
        </div>
      </div>

    </div>
`;

  //ç¯€é»é«˜äº®
  document.querySelectorAll(".timeline-dot").forEach(d => d.classList.remove("active"));
  // æ”¯æ´å…©ç¨®æƒ…æ³ï¼š
  // 1) é»æ“Šæ™‚é–“è»¸ä¸Šçš„ DOM buttonï¼ˆe.currentTarget ç‚ºè©² elementï¼‰
  // 2) å¾ Leaflet marker è§¸ç™¼ï¼ˆå‚³å…¥çš„ e.currentTarget ä¸æ˜¯ DOM elementï¼‰ï¼Œç”¨ memory.id æ‰¾å°æ‡‰çš„ .timeline-dot
  let targetEl = null;
  try {
    if (e && e.currentTarget && e.currentTarget.classList) {
      targetEl = e.currentTarget;
    }
  } catch (err) {
    // ignore
  }
  if (!targetEl) {
    targetEl = document.querySelector(`.timeline-dot[data-id="${memory.id}"]`);
  }
  if (targetEl && targetEl.classList) {
    targetEl.classList.add("active");
    // è‹¥ç¯€é»ä½æ–¼ä¸å¯è¦‹å€ï¼Œå¹³æ»‘æ»¾å‹•åˆ°å¯è¦–ç¯„åœ
    try { targetEl.scrollIntoView({ behavior: 'smooth', inline: 'center' }); } catch (e) {}
  }
  // ç¶å®šå¡ç‰‡å…§çš„ç·¨è¼¯æŒ‰éˆ•
  const cardEditBtn = document.getElementById(`openEditBtn-card-${memory.id}`);
  if (cardEditBtn) cardEditBtn.onclick = () => openEditModal(memory);
}

// ğŸŒŸ é–‹å•Ÿç·¨è¼¯ç•«é¢
function openEditModal(memory) {
  const modal = document.getElementById("editModal");
  const textArea = document.getElementById("editTextArea");
  const preview = document.getElementById("editPreview");

  modal.classList.remove("hidden");
  try { modal.style.display = 'flex'; modal.style.position = 'fixed'; modal.style.zIndex = '10050'; } catch (e) {}
  textArea.value = memory.text || "";
  
  if (memory.photo_url) {
    preview.src = `${BACKEND_URL}${memory.photo_url}`;
    preview.classList.remove("hidden");
  } else {
    preview.classList.add("hidden");
  }

  // ç¶å®šä¸Šå‚³äº‹ä»¶ï¼ˆguard å¯¦é«”å­˜åœ¨ï¼‰
  const upload = document.getElementById("editUpload");
  if (upload) {
    upload.onchange = async (e) => {
    try { if (e && e.preventDefault) e.preventDefault(); } catch(e) {}
    try { if (e && e.stopPropagation) e.stopPropagation(); } catch(e) {}
    const statusEl = document.getElementById('editUploadStatus');
    try {
      const file = e.target.files[0];
      if (!file) return;

      // é¡¯ç¤ºä¸Šå‚³ä¸­
      statusEl.classList.remove('hidden');
      statusEl.classList.remove('text-red-600');
      statusEl.classList.add('text-gray-600');
      statusEl.textContent = 'ä¸Šå‚³ä¸­...';

      const formData = new FormData();
      formData.append("file", file);

      const res = await fetch(`${BACKEND_URL}/api/memories/photo/${memory.id}`, {
        method: "POST",
        body: formData
      });

      if (!res.ok) {
        const txt = await res.text();
        throw new Error(txt || 'ä¸Šå‚³å¤±æ•—');
      }

      const data = await res.json();
      if (data.photo_url) {
        preview.src = `${BACKEND_URL}${data.photo_url}`;
        preview.classList.remove("hidden");
        statusEl.classList.remove('text-gray-600');
        statusEl.classList.add('text-green-600');
        statusEl.textContent = 'âœ… ç…§ç‰‡å·²ä¸Šå‚³';
      } else {
        throw new Error('ä¼ºæœå™¨æœªå›å‚³ photo_url');
      }
    } catch (err) {
      console.error('upload error', err);
      statusEl.classList.remove('text-gray-600','text-green-600');
      statusEl.classList.add('text-red-600');
      statusEl.textContent = 'âŒ ä¸Šå‚³å¤±æ•—';
    } finally {
      // ç¢ºä¿ modal ä¸æœƒåœ¨ä¸Šå‚³å¾Œæ„å¤–é—œé–‰æˆ–å°è‡´è¦–åœ–å›åˆ°é¦–é 
      try { document.getElementById('editModal').classList.remove('hidden'); } catch (e) {}
    }
    };
  } else {
    console.warn('openEditModal: editUpload element not found');
  }

  // å„²å­˜ä¿®æ”¹
  const btnSaveEl = document.getElementById("btnSaveEdit");
  if (btnSaveEl) {
    btnSaveEl.onclick = async () => {
    const newText = textArea.value.trim();
    const res = await fetch(`${BACKEND_URL}/api/memories/${memory.id}`, {
      method: "PUT",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ text: newText })
    });

    if (res.ok) {
        showToast('âœ… å·²å„²å­˜ä¿®æ”¹ï¼', { type: 'success' });
      closeEditModal();
      await loadMemories();
    } else {
        showToast('âŒ å„²å­˜å¤±æ•—', { type: 'error' });
    }
    };
  } else {
    console.warn('openEditModal: btnSaveEdit element not found');
  }

  // è¿”å›ï¼å–æ¶ˆ
  const btnBackEl = document.getElementById("btnBackEdit");
  if (btnBackEl) btnBackEl.onclick = closeEditModal;
  const btnCancelEl = document.getElementById("btnCancelEdit");
  if (btnCancelEl) btnCancelEl.onclick = closeEditModal;
}

// ğŸŒŸ é—œé–‰ç·¨è¼¯ç•«é¢
function closeEditModal() {
  const em = document.getElementById("editModal");
  if (em) {
    em.classList.add("hidden");
    try { em.style.display = 'none'; } catch (e) {}
  }
}



renderCharacterCards();
switchView('empty');
// åˆå§‹åŒ–å…©å€‹éŒ„éŸ³æŒ‰éˆ•
setupRecorder("recordBtn", "charPrompt");   // è§’è‰²é éŒ„éŸ³
setupRecorder("recordBtnChat", "chatInput"); // èŠå¤©é éŒ„éŸ³ âœ…

// === å®‰å…¨è§¸ç™¼ï¼šç¢ºä¿åœ°åœ–èˆ‡ç¯€é»è¼‰å…¥ ===
document.addEventListener("DOMContentLoaded", () => {
  console.log("ğŸŒ DOM Loadedï¼Œåˆå§‹åŒ–åœ°åœ–æª¢æŸ¥");
  if (map) {
    setTimeout(() => {
      map.invalidateSize();
      loadMemories();
    }, 500);
  } else {
    console.error("âŒ map æœªåˆå§‹åŒ–");
  }
});


// === ç¶å®šç¬¬ä¸€é é€å‡ºæŒ‰éˆ• (#charSend0) åˆ°ä»˜è²» modalï¼ˆè²éŸ³â†’åœ–éœ€ä»˜è²»ï¼‰ ===
try {
  const charSendBtn = document.getElementById('charSend0');
  const payModal = document.getElementById('payModal');
  const payPreview = document.getElementById('payPreview');
  const btnConfirmPay = document.getElementById('btnConfirmPay');
  const btnCancelPay = document.getElementById('btnCancelPay');
  const charPromptEl = document.getElementById('charPrompt');

  if (charSendBtn) {
    charSendBtn.addEventListener('click', (e) => {
      console.log('charSend0 clicked');
      // æŠŠç•¶å‰çš„è¼¸å…¥æˆ–éŒ„éŸ³æ–‡å­—æ”¾åˆ°ä»˜è²»é è¦½å€
      try { payPreview.textContent = (charPromptEl && charPromptEl.value) ? charPromptEl.value : ''; } catch (err) { console.warn('payPreview set failed', err); }
      if (payModal) {
        // å¼·åˆ¶æˆå›ºå®šå®šä½ä¸¦æé«˜å±¤ç´šï¼Œé¿å…è¢«å…¶ä»–å…ƒç´ è¦†è“‹
        payModal.style.display = 'flex';
        payModal.style.position = 'fixed';
        payModal.style.zIndex = '9999';
        console.log('Opening payModal');
      } else {
        console.warn('payModal element not found');
      }
    });
  } else {
    console.warn('#charSend0 not found when binding pay modal');
  }

  if (btnCancelPay) {
    btnCancelPay.addEventListener('click', () => {
      if (payModal) payModal.style.display = 'none';
    });
  }

  if (btnConfirmPay) {
    btnConfirmPay.addEventListener('click', async () => {
      // ä»˜è²»æˆåŠŸçš„ç¤ºæ„è™•ç†ï¼šé—œé–‰ modal ä¸¦è§¸ç™¼å¯¦éš›é€å‡ºæµç¨‹
      showToast('ğŸ”“ å·²å®Œæˆä»˜è²»ï¼Œæ­£åœ¨å•Ÿç”¨åŠŸèƒ½...', { type: 'success' });
      if (payModal) payModal.style.display = 'none';

      // å˜—è©¦å¾è§’è‰²é çš„è¼¸å…¥æ¬„å–æ–‡å­—ä¸¦é€å‡ºï¼ˆè‹¥æœ‰ performChatSend å‡½å¼å‰‡å‘¼å«ï¼‰
      try {
        const txt = (charPromptEl && charPromptEl.value) ? charPromptEl.value : '';
        if (typeof performChatSend === 'function') {
          await performChatSend(txt);
        } else {
          // fallback: å»ºç«‹è¨˜æ†¶ï¼ˆèˆ‡èŠå¤©é€å‡ºç›¸åŒçš„ APIï¼‰
          if (txt && txt.trim()) {
            await fetch(`${BACKEND_URL}/api/memories`, {
              method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ text: txt })
            });
            appendMessage('user', txt);
            // ğŸš« ä¸å†é‡è¤‡é¡¯ç¤º AI å›è¦†ï¼Œè®“ä¸Šå±¤ chatSend ä¿æŒå”¯ä¸€è¨Šæ¯
            try {
              await fetch(`${BACKEND_URL}/api/memories`, {
                method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ text: txt })
              });
              showToast('âœ… å·²å°‡é€™æ®µæ–‡å­—å„²å­˜åˆ°ç”Ÿå‘½åœ°åœ–ï¼ˆä»˜è²»åŠŸèƒ½ï¼‰ï¼', { type: 'success' });
              await loadMemories();
              await renderTimeline();
            } catch (e) {
              console.warn(e);
            }
          }
        }
      } catch (err) {
        console.error('Confirm pay action failed', err);
        showToast('âŒ ä»˜è²»è™•ç†å¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦', { type: 'error' });
      }
    });
  }
} catch (err) {
  console.error('bind charSend0 -> payModal failed', err);
}


// Debug helper: æª¢æŸ¥ #charSend0 æ˜¯å¦è¢«é®è“‹ï¼Œä¸¦å˜—è©¦å°‡å®ƒå¸¶åˆ°æœ€ä¸Šå±¤ä»¥æ¢å¾©å¯é»æ“Šæ€§
setTimeout(() => {
  try {
    const btn = document.getElementById('charSend0');
    if (!btn) return console.warn('#charSend0 not found in DOM during clickable-check');
    const rect = btn.getBoundingClientRect();
    const cx = rect.left + rect.width / 2;
    const cy = rect.top + rect.height / 2;
    const topEl = document.elementFromPoint(cx, cy);
    console.log('clickable-check: element at charSend0 center ->', topEl, topEl && topEl.id, topEl && topEl.className);

    // è‹¥æŒ‰éˆ•ä¸Šæ–¹çš„å…ƒç´ ä¸æ˜¯æŒ‰éˆ•æœ¬èº«æˆ–å…¶å­å­«ï¼Œè¦–ç‚ºè¢«é®è“‹
    if (topEl && topEl !== btn && !btn.contains(topEl)) {
      console.warn('charSend0 appears to be covered by:', topEl);
      // å¼·åˆ¶æå‡æŒ‰éˆ•å±¤ç´šèˆ‡å•Ÿç”¨ pointer events
      try { btn.style.position = 'relative'; } catch (e) {}
      try { btn.style.zIndex = '10001'; } catch (e) {}
      try { btn.style.pointerEvents = 'auto'; } catch (e) {}
      // ä¹Ÿæå‡çˆ¶å®¹å™¨å±¤ç´š
      try { if (btn.parentElement) btn.parentElement.style.zIndex = '10001'; } catch (e) {}
      console.log('charSend0 z-index/pointer-events adjusted to attempt to restore clickability');
    }
  } catch (err) {
    console.error('clickable-check failed', err);
  }
}, 300);

// æŠŠé—œéµ modal ç§»åˆ° body æœ«ç«¯ï¼Œé¿å…è¢«çˆ¶å®¹å™¨çš„ stacking context æˆ– overflow æ“‹ä½
try {
  ['payModal','editModal','deleteConfirm','shareModal'].forEach(id => {
    const el = document.getElementById(id);
    if (el && el.parentElement && el.parentElement !== document.body) {
      try {
        document.body.appendChild(el);
        console.log(`moved ${id} to document.body`);
        // ensure hidden modals use display:none when hidden
        if (el.classList.contains('hidden')) el.style.display = 'none';
      } catch (e) {
        console.warn('failed to move', id, e);
      }
    }
  });
} catch (err) {
  console.warn('move modals to body failed', err);
}

// Document-level click forwarder: è‹¥é»æ“Šè¢«è¦†è“‹ä½†è½åœ¨ charSend0 çš„ç¯„åœå…§ï¼Œæ›¿æŒ‰éˆ•è§¸ç™¼ click
try {
  const tryForwardClick = (e) => {
    const btn = document.getElementById('charSend0');
    if (!btn) return;
    // å¦‚æœé»æ“Šç›®æ¨™å°±æ˜¯æŒ‰éˆ•ï¼ˆæˆ–æŒ‰éˆ•å…§ï¼‰ï¼Œä¸è™•ç†
    if (e.target && (e.target === btn || btn.contains(e.target))) return;
    const rect = btn.getBoundingClientRect();
    const x = e.clientX, y = e.clientY;
    if (x >= rect.left && x <= rect.right && y >= rect.top && y <= rect.bottom) {
      console.log('document click forwarder: forwarding click to #charSend0');
      try {
        // dispatch a synthetic click on the button
        btn.dispatchEvent(new MouseEvent('click', { bubbles: true, cancelable: true, view: window }));
      } catch (err) {
        console.error('forward click failed', err);
      }
    }
  };
  // use capture to run early
  document.addEventListener('click', tryForwardClick, true);
} catch (err) {
  console.error('add document click forwarder failed', err);
}

// Delegated handler for dynamically generated edit buttons (openEditBtn-<id>)
document.addEventListener('click', function (e) {
  try {
    const btn = e.target.closest && e.target.closest('[id^="openEditBtn-"]');
    if (!btn) return;
    const idMatch = btn.id.match(/^openEditBtn-(.+)$/);
    if (!idMatch) return;
    const midRaw = idMatch[1];
    // find memory from cache
    const mems = window._memories || [];
    let m = null;
    // support fallback ids like 'missing-<index>' produced elsewhere
    const missingMatch = String(midRaw).match(/^missing-(\d+)$/);
    if (missingMatch) {
      const idx = parseInt(missingMatch[1]);
      if (!isNaN(idx) && idx >= 0 && idx < mems.length) m = mems[idx];
    }
    if (!m) {
      m = mems.find(x => String(x.id) === String(midRaw));
    }
    if (!m) {
      // as a last resort, try numeric conversion
      const maybeNum = Number(midRaw);
      if (!isNaN(maybeNum)) m = mems.find(x => Number(x.id) === maybeNum);
    }
    if (m) {
      openEditModal(m);
    } else {
      console.warn('edit button clicked but memory not found for id', midRaw, 'memories_count=', mems.length);
    }
  } catch (err) {
    console.error('delegated edit button handler error', err);
  }
});
document.addEventListener("DOMContentLoaded", () => {
  const share = document.getElementById('shareModal');
  if (share && share.parentElement !== document.body) {
    document.body.appendChild(share);
    console.log("âœ… shareModal å·²ç§»å‡ºæ‰‹æ©Ÿæ¡†æ¶");
  }
  const style = document.createElement("style");
  style.textContent = `
    #shareModal { position: fixed !important; z-index: 99999 !important; }
    #shareModal > div { z-index: 100000 !important; }
  `;
  document.head.appendChild(style);
  
  // å¼·åŒ–åˆ†äº«æŒ‰éˆ•ç¶å®šï¼ˆå¤šé‡ä¿éšªï¼‰
  const shareButtons = document.querySelectorAll('button[onclick*="openShareModal"], button:contains("åˆ†äº«")');
  shareButtons.forEach(btn => {
    btn.addEventListener('click', (e) => {
      console.log('Share button clicked via delegated listener');
      e.preventDefault();
      e.stopPropagation();
      openShareModal();
    });
  });
  
  // ä¹Ÿå¯ä»¥é€šéæ–‡å­—å…§å®¹æ‰¾åˆ†äº«æŒ‰éˆ•
  document.querySelectorAll('button').forEach(btn => {
    if (btn.textContent && btn.textContent.includes('åˆ†äº«')) {
      btn.addEventListener('click', (e) => {
        console.log('Share button found by text content, opening modal');
        e.preventDefault();
        e.stopPropagation();
        openShareModal();
      });
    }
  });
});
</script>

</body>
</html>