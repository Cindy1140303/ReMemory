<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>語憶心聲｜後端資料檢視</title>
    <script src="https://unpkg.com/vue@3/dist/vue.global.prod.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body { font-family: 'Inter', 'Noto Sans TC', sans-serif; }
        .fade-enter-active, .fade-leave-active {
            transition: opacity 0.5s, transform 0.5s;
        }
        .fade-enter-from, .fade-leave-to {
            opacity: 0;
            transform: translateY(20px);
        }
    </style>
</head>
<body class="bg-gray-50 min-h-screen">
    <div id="app" class="p-4 sm:p-8 max-w-7xl mx-auto">
        <header class="mb-6 border-b pb-4">
            <h1 class="text-3xl font-extrabold text-gray-800 tracking-tight">語憶心聲後端資料檢視</h1>
            <p class="text-gray-500 mt-1">即時查看語音檔案的分析狀態與結果。</p>
        </header>

        <!-- 重新載入按鈕 -->
        <div class="mb-4 text-right">
            <button
                class="bg-gray-700 hover:bg-gray-900 text-white px-5 py-2 rounded-lg transition duration-150 shadow-md focus:outline-none focus:ring-2 focus:ring-gray-500 focus:ring-offset-2 disabled:opacity-50"
                @click="fetchRecords"
                :disabled="loading"
            >
                重新整理
            </button>
        </div>

        <!-- 表格 -->
        <div class="bg-white shadow-xl rounded-md overflow-hidden">
            <table class="min-w-full divide-y divide-gray-200">
                <thead class="bg-teal-700 text-white">
                    <tr>
                        <th class="px-4 py-3 text-left text-sm font-semibold tracking-wider w-20">ID</th> 
                        <th class="px-4 py-3 text-left text-sm font-semibold tracking-wider">檔案名</th>
                        <th class="px-4 py-3 text-left text-sm font-semibold tracking-wider">分析狀態</th>
                        <th class="px-4 py-3 text-left text-sm font-semibold tracking-wider hidden sm:table-cell">地區分析</th>
                        <th class="px-4 py-3 text-left text-sm font-semibold tracking-wider hidden sm:table-cell">興趣分析</th>
                        <th class="px-4 py-3 text-center text-sm font-semibold tracking-wider">操作</th>
                    </tr>
                </thead>
                <tbody class="divide-y divide-gray-200">
                    <tr v-if="records.length === 0 && !loading" class="text-center">
                        <td colspan="6" class="p-8 text-gray-500">目前沒有任何語音記錄。</td>
                    </tr>
                    <tr v-for="r in paginatedRecords" :key="r._id" class="hover:bg-blue-50 transition duration-150">
                        <td class="px-4 py-3 text-xs text-gray-500 truncate max-w-[5rem] sm:max-w-none">{{ r._id }}</td> 
                        <td class="px-4 py-3 text-sm font-medium text-gray-900">{{ r.filename || '未命名' }}</td>
                        <td class="px-4 py-3 text-sm">
                            <span :class="{
                                'bg-green-100 text-green-800': r.status === 'done',
                                'bg-yellow-100 text-yellow-800 animate-pulse': r.status === 'processing',
                                'bg-gray-100 text-gray-600': !r.status
                            }" class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full">
                                {{ statusText(r.status) }}
                            </span>
                        </td>
                        <td class="px-4 py-3 text-sm text-gray-500 hidden sm:table-cell">{{ r.region || '-' }}</td>
                        <td class="px-4 py-3 text-sm text-gray-500 hidden sm:table-cell">{{ r.interest || '-' }}</td>
                        <td class="px-4 py-3 text-center text-sm font-medium">
                            <button
                                class="bg-blue-500 hover:bg-blue-700 text-white px-3 py-1 rounded-lg text-xs transition duration-150 shadow-md hover:shadow-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2"
                                @click="prepareReanalyze(r._id)"
                                :disabled="loading"
                            >
                                重新分析
                            </button>
                        </td>
                    </tr>
                </tbody>
            </table>
        </div>

        <!-- 底部分頁 -->
        <div class="mt-6 flex flex-col sm:flex-row justify-between items-center space-y-4 sm:space-y-0">
            <div class="w-full sm:w-auto">
                <div v-if="loading" class="text-blue-600 flex items-center">
                    <svg class="animate-spin -ml-1 mr-3 h-5 w-5 text-blue-500" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                        <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                        <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                    </svg>
                    資料載入中...
                </div>
                <div v-else-if="error" class="text-red-600 flex items-center">
                    <span class="mr-2 text-xl">⚠️</span> {{ error }}
                </div>
                <div v-else-if="records.length > 0" class="text-gray-500 text-sm">
                    顯示 {{ (currentPage - 1) * itemsPerPage + 1 }} - {{ Math.min(currentPage * itemsPerPage, records.length) }} 筆 (共 {{ records.length }} 筆)。
                </div>
            </div>

            <div v-if="totalPages > 1" class="flex items-center space-x-2 w-full sm:w-auto justify-center sm:justify-end">
                <button @click="changePage(currentPage - 1)" :disabled="currentPage === 1"
                    class="px-3 py-1 text-sm font-medium text-gray-700 bg-white border border-gray-300 rounded-lg hover:bg-gray-100 disabled:opacity-50">
                    上一頁
                </button>
                <span class="text-gray-700 text-sm font-semibold">第 {{ currentPage }} / {{ totalPages }} 頁</span>
                <button @click="changePage(currentPage + 1)" :disabled="currentPage === totalPages"
                    class="px-3 py-1 text-sm font-medium text-gray-700 bg-white border border-gray-300 rounded-lg hover:bg-gray-100 disabled:opacity-50">
                    下一頁
                </button>
            </div>
        </div>

        <!-- 訊息框 -->
        <transition name="fade">
            <div v-if="messageState.show" :class="messageClass" class="fixed bottom-5 right-5 p-4 rounded-lg shadow-xl z-50 transition duration-300">
                {{ messageState.message }}
            </div>
        </transition>

        <!-- 確認框 -->
        <transition name="fade">
            <div v-if="modalState.show" class="fixed inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center z-50">
                <div class="bg-white p-6 rounded-xl shadow-2xl w-full max-w-sm m-4">
                    <h3 class="text-lg font-bold text-gray-900 mb-3">確認操作</h3>
                    <p class="text-sm text-gray-600 mb-6">{{ modalState.message }}</p>
                    <div class="flex justify-end space-x-3">
                        <button class="px-4 py-2 text-sm font-medium text-gray-700 bg-gray-200 rounded-lg hover:bg-gray-300"
                                @click="handleModalAction(false)">取消</button>
                        <button class="px-4 py-2 text-sm font-medium text-white bg-blue-600 rounded-lg hover:bg-blue-700"
                                @click="handleModalAction(true)">確定重新分析</button>
                    </div>
                </div>
            </div>
        </transition>
    </div>

    <script>
        const { createApp, ref, computed, onMounted } = Vue;

        createApp({
            setup() {
                const records = ref([]);
                const loading = ref(false);
                const error = ref('');
                const itemsPerPage = ref(10);
                const currentPage = ref(1);

                const modalState = ref({ show: false, message: '', recordId: null });
                const messageState = ref({ show: false, message: '', type: 'success' });

                const totalPages = computed(() => Math.max(1, Math.ceil(records.value.length / itemsPerPage.value)));
                const paginatedRecords = computed(() => {
                    const start = (currentPage.value - 1) * itemsPerPage.value;
                    return records.value.slice(start, start + itemsPerPage.value);
                });

                const messageClass = computed(() =>
                    messageState.value.type === 'error'
                        ? 'bg-red-500 text-white'
                        : 'bg-green-500 text-white'
                );

                const statusText = (status) => {
                    if (status === 'done') return '✅ 分析完成';
                    if (status === 'processing') return '⏳ 處理中';
                    return '❌ 未分析';
                };

                const showMessage = (msg, type = 'success') => {
                    messageState.value = { show: true, message: msg, type };
                    setTimeout(() => (messageState.value.show = false), 3000);
                };

                const fetchRecords = async () => {
                    loading.value = true;
                    error.value = '';
                    try {
                        const res = await fetch('/api/records');
                        if (!res.ok) throw new Error(`HTTP ${res.status}`);
                        records.value = await res.json();
                        currentPage.value = 1;
                    } catch (err) {
                        error.value = '讀取資料失敗：' + err.message;
                        showMessage(error.value, 'error');
                    } finally {
                        loading.value = false;
                    }
                };

                const prepareReanalyze = (id) => {
                    modalState.value = {
                        show: true,
                        message: '確定要重新分析這筆資料嗎？',
                        recordId: id
                    };
                };

                const handleModalAction = async (confirm) => {
                    const id = modalState.value.recordId;
                    modalState.value.show = false;
                    if (!confirm || !id) return;

                    try {
                        const res = await fetch(`/api/analyze?id=${id}`, { method: 'POST' });
                        const data = await res.json();
                        if (!res.ok || !data.ok) throw new Error(data.message || '後端分析失敗');
                        showMessage(`分析任務已啟動！(ID: ${id})`);
                        fetchRecords();
                    } catch (err) {
                        showMessage('重新分析失敗：' + err.message, 'error');
                    }
                };

                const changePage = (page) => {
                    if (page >= 1 && page <= totalPages.value) currentPage.value = page;
                };

                onMounted(fetchRecords);

                return {
                    records, loading, error,
                    modalState, messageState, messageClass,
                    paginatedRecords, totalPages, currentPage,
                    fetchRecords, prepareReanalyze, handleModalAction, changePage, statusText
                };
            }
        }).mount('#app');
    </script>
</body>
</html>